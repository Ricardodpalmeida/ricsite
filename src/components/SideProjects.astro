---
import { getLangFromUrl, useTranslations } from '../i18n/utils';

// Get current language and translations
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Get all images using Astro.glob
const galleryImageModules = await Astro.glob('/public/images/HomePhotoGallery/*.{jpg,jpeg,png}');
const galleryImages = galleryImageModules.map(module => module.default.src);
---

<section class="side-projects-section">
  <div class="section-container">
    <h2 class="section-title">Side Projects</h2>
    
    <!-- Podcast Section -->
    <div class="project-container">
      <h3 class="subsection-title">Podcast</h3>
      <p class="section-description">
        'Mesa do Canto' was a podcast in Portuguese where a friend and I convened to discuss a variety of subjects, 
        including culture, politics, philosophy, history, economics, and technology.
      </p>
      <div class="podcast-embed">
        <iframe 
          style="border-radius:12px" 
          src="https://open.spotify.com/embed/show/4lj3PvhecSWd5wUJAF3Lk6?utm_source=generator&theme=0" 
          width="100%" 
          height="352" 
          frameBorder="0" 
          allowfullscreen="" 
          allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
          loading="lazy"
        ></iframe>
      </div>
    </div>
    
    <!-- DJ Sets Section -->
    <div class="project-container">
      <h3 class="subsection-title">Latest Sets</h3>
      <p class="section-description">
        I'm a DJ specializing in Jazz, African Funk and Jazz, Deep, Future, Disco and Progressive House, 
        along with other world music like Habibi Funk. All my sets are improvised, mixing both vinyl and digital formats.
      </p>
      <div class="sets-carousel">
        <button class="carousel-arrow prev" aria-label="Previous set">←</button>
        <div class="carousel-container">
          <div class="carousel-track">
            <div class="carousel-item">
              <iframe width="100%" height="120" src="https://player-widget.mixcloud.com/widget/iframe/?hide_cover=1&feed=%2Fricardo-almeida28%2Fnadar%2F" frameborder="0" title="Nadar"></iframe>
            </div>
            <div class="carousel-item">
              <iframe width="100%" height="120" src="https://player-widget.mixcloud.com/widget/iframe/?hide_cover=1&feed=%2Fricardo-almeida28%2Ffenix%2F" frameborder="0" title="Fenix"></iframe>
            </div>
            <div class="carousel-item">
              <iframe width="100%" height="120" src="https://player-widget.mixcloud.com/widget/iframe/?hide_cover=1&feed=%2Fricardo-almeida28%2Flejos%2F" frameborder="0" title="Lejos"></iframe>
            </div>
          </div>
        </div>
        <button class="carousel-arrow next" aria-label="Next set">→</button>
      </div>
    </div>

    <!-- Playlists Section -->
    <div class="project-container">
      <h3 class="subsection-title">My Playlists</h3>
      <div class="playlists-gallery">
        <div class="playlist-item">
          <iframe style="border-radius:12px" src="https://open.spotify.com/embed/playlist/2EOgO6HyRqoFVyoS5DeGHg?utm_source=generator&theme=0" width="100%" height="352" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy" title="Playlist 1"></iframe>
        </div>
        <div class="playlist-item">
          <iframe style="border-radius:12px" src="https://open.spotify.com/embed/playlist/0yWK4qg5GYnriJbJVVq159?utm_source=generator&theme=0" width="100%" height="352" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy" title="Playlist 2"></iframe>
        </div>
        <div class="playlist-item">
          <iframe style="border-radius:12px" src="https://open.spotify.com/embed/playlist/3YAOE2K50HfP25uBowFRJJ?utm_source=generator&theme=0" width="100%" height="352" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy" title="Playlist 3"></iframe>
        </div>
      </div>
    </div>

    <!-- Photography Section -->
    <div class="project-container">
      <h3 class="subsection-title">Photography</h3>
      <p class="section-description">
        Photography allows me to capture the beauty in everyday moments. My work focuses on urban landscapes, 
        architectural details, and the interplay of light and shadow in city environments.
      </p>
      <div class="photo-gallery">
        {galleryImages.map((imageSrc: string, i: number) => (
          <div class="photo-item" data-index={i}>
            <img 
              src={imageSrc}
              alt={`Gallery photo ${i + 1}`}
              loading="lazy"
              oncontextmenu="return false;"
            />
          </div>
        ))}
      </div>
    </div>
  </div>
</section>

<!-- Modal for Photo Viewing -->
<div class="photo-modal" id="photoModal">
  <button class="modal-close" aria-label="Close modal">×</button>
  <button class="modal-nav prev" aria-label="Previous photo">←</button>
  <button class="modal-nav next" aria-label="Next photo">→</button>
  <div class="modal-content">
    <img src="" alt="" oncontextmenu="return false;" />
  </div>
</div>

<style>
  .side-projects-section {
    padding: 4rem 0;
    background: var(--color-gray-900);
  }

  .section-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 0 1rem;
  }

  .section-title {
    font-size: var(--font-size-2xl);
    color: var(--color-cosmic-latte);
    margin-bottom: 2rem;
    font-family: var(--font-family-title);
  }

  .project-container {
    margin-bottom: 4rem;
  }

  .project-container:last-child {
    margin-bottom: 0;
  }

  .subsection-title {
    font-size: var(--font-size-xl);
    color: var(--color-cosmic-latte);
    margin-bottom: 1rem;
    font-family: var(--font-family-title);
  }

  .section-description {
    margin-bottom: 2rem;
    line-height: var(--line-height-loose);
  }

  /* Sets Carousel Styles */
  .sets-carousel {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .carousel-container {
    flex: 1;
    overflow: hidden;
  }

  .carousel-track {
    display: flex;
    transition: transform 0.3s ease;
  }

  .carousel-item {
    flex: 0 0 100%;
    padding: 0 0.5rem;
  }

  .carousel-arrow {
    background: var(--color-cosmic-latte-10);
    border: 1px solid var(--color-cosmic-latte);
    color: var(--color-white);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
  }

  .carousel-arrow:hover {
    background: var(--color-cosmic-latte-20);
    transform: scale(1.1);
  }

  /* Playlists Gallery Styles */
  .playlists-gallery {
    display: flex;
    gap: 1rem;
    overflow-x: auto;
    padding: 1rem 0;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
  }

  /* Custom Scrollbar for Playlists */
  .playlists-gallery::-webkit-scrollbar {
    height: 6px;
  }

  .playlists-gallery::-webkit-scrollbar-track {
    background: var(--color-cosmic-latte-10);
    border-radius: 3px;
  }

  .playlists-gallery::-webkit-scrollbar-thumb {
    background: var(--color-cosmic-latte);
    border-radius: 3px;
  }

  .playlists-gallery::-webkit-scrollbar-thumb:hover {
    background: var(--color-cosmic-latte-20);
  }

  /* Firefox scrollbar */
  .playlists-gallery {
    scrollbar-width: thin;
    scrollbar-color: var(--color-cosmic-latte) var(--color-cosmic-latte-10);
  }

  .playlist-item {
    flex: 0 0 50%;
    scroll-snap-align: start;
  }

  /* Photo Gallery Styles */
  .photo-gallery {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .photo-item {
    position: relative;
    aspect-ratio: 3/4;
    overflow: hidden;
    border-radius: 8px;
    cursor: pointer;
    transition: transform 0.3s ease;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  }

  .photo-item:hover {
    transform: scale(1.02);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
  }

  .photo-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    user-select: none;
    -webkit-user-select: none;
  }

  /* Modal Styles */
  .photo-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    z-index: 1000;
    padding: 2rem;
    align-items: center;
    justify-content: center;
  }

  .photo-modal.active {
    display: flex;
  }

  .modal-content {
    position: relative;
    max-width: 90vw;
    max-height: 90vh;
  }

  .modal-content img {
    max-width: 100%;
    max-height: 90vh;
    object-fit: contain;
    user-select: none;
    -webkit-user-select: none;
  }

  .modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: var(--color-cosmic-latte-10);
    border: 1px solid var(--color-cosmic-latte);
    color: var(--color-white);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    z-index: 1001;
  }

  .modal-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: var(--color-cosmic-latte-10);
    border: 1px solid var(--color-cosmic-latte);
    color: var(--color-white);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    z-index: 1001;
  }

  .modal-nav.prev {
    left: 1rem;
  }

  .modal-nav.next {
    right: 1rem;
  }

  .modal-close:hover,
  .modal-nav:hover {
    background: var(--color-cosmic-latte-20);
    transform: scale(1.1);
  }

  .modal-nav.prev:hover {
    transform: translateY(-50%) scale(1.1);
  }

  .modal-nav.next:hover {
    transform: translateY(-50%) scale(1.1);
  }

  /* Responsive Styles */
  @media (max-width: 768px) {
    .playlist-item {
      flex: 0 0 100%;
    }

    .section-title {
      font-size: var(--font-size-xl);
    }

    .subsection-title {
      font-size: var(--font-size-lg);
    }
  }
</style>

<script>
  // Carousel functionality
  const carouselTrack = document.querySelector('.carousel-track') as HTMLElement;
  const carouselItems = document.querySelectorAll('.carousel-item');
  const carouselPrevBtn = document.querySelector('.carousel-arrow.prev') as HTMLButtonElement;
  const carouselNextBtn = document.querySelector('.carousel-arrow.next') as HTMLButtonElement;
  
  let currentIndex = 0;

  function updateCarousel() {
    if (carouselTrack) {
      const percentage = currentIndex * -100;
      carouselTrack.style.transform = `translateX(${percentage}%)`;
      
      // Update button states
      if (carouselPrevBtn) carouselPrevBtn.disabled = currentIndex === 0;
      if (carouselNextBtn) carouselNextBtn.disabled = currentIndex === carouselItems.length - 1;
    }
  }

  carouselPrevBtn?.addEventListener('click', () => {
    if (currentIndex > 0) {
      currentIndex--;
      updateCarousel();
    }
  });

  carouselNextBtn?.addEventListener('click', () => {
    if (currentIndex < carouselItems.length - 1) {
      currentIndex++;
      updateCarousel();
    }
  });

  // Initialize carousel
  updateCarousel();

  // Photo Gallery Modal Functionality
  const modal = document.getElementById('photoModal') as HTMLElement;
  const modalImg = modal?.querySelector('img') as HTMLImageElement;
  const modalCloseBtn = modal?.querySelector('.modal-close');
  const modalPrevBtn = modal?.querySelector('.modal-nav.prev');
  const modalNextBtn = modal?.querySelector('.modal-nav.next');
  const photoItems = document.querySelectorAll('.photo-item');
  let currentPhotoIndex = 0;

  function openModal(index: number) {
    if (!modal || !modalImg) return;
    currentPhotoIndex = index;
    const photoSrc = photoItems[index]?.querySelector('img')?.src;
    if (photoSrc) {
      modalImg.src = photoSrc;
      modalImg.alt = `Photo ${index + 1}`;
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }
  }

  function closeModal() {
    if (!modal) return;
    modal.classList.remove('active');
    document.body.style.overflow = '';
  }

  function navigatePhoto(direction: 'prev' | 'next') {
    const newIndex = direction === 'prev' 
      ? Math.max(0, currentPhotoIndex - 1)
      : Math.min(photoItems.length - 1, currentPhotoIndex + 1);
    
    if (newIndex !== currentPhotoIndex) {
      openModal(newIndex);
    }
  }

  // Event Listeners
  photoItems.forEach((item, index) => {
    item.addEventListener('click', () => openModal(index));
  });

  modalCloseBtn?.addEventListener('click', closeModal);
  modalPrevBtn?.addEventListener('click', () => navigatePhoto('prev'));
  modalNextBtn?.addEventListener('click', () => navigatePhoto('next'));

  // Close modal on escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeModal();
    if (e.key === 'ArrowLeft') navigatePhoto('prev');
    if (e.key === 'ArrowRight') navigatePhoto('next');
  });

  // Close modal when clicking outside the image
  modal?.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });

  // Prevent right-click on all gallery images
  document.addEventListener('contextmenu', (e) => {
    if (e.target instanceof HTMLImageElement) {
      e.preventDefault();
    }
  });
</script> 