---
import { getLangFromUrl, useTranslations } from '../i18n/utils';
import { getCollection } from 'astro:content';
import { marked } from 'marked';
import PhotoModal from './PhotoModal.astro';
import '../styles/photo-gallery.css';
import '../styles/carousel.css';

// Get current language and translations
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Get profile data from content collection
const profileData = await getCollection('profile');
const profileEntry = profileData.find(entry => entry.data.language === lang);
const profileInfo = profileEntry?.data || null;
const sideProjects = profileInfo?.sideProjects || {};
const sectionDescription = profileInfo?.sectionDescriptions?.sideProjects || '';

// Process markdown in descriptions
const processMarkdown = (text: string) => {
  if (!text) return '';
  // Configure marked to only allow certain markdown features (bold, italic)
  marked.setOptions({
    gfm: true,
    breaks: true
  });
  return marked.parse(text);
};

// Get all images using Astro.glob
const galleryImageModules = await Astro.glob('/public/images/HomePhotoGallery/*.{jpg,jpeg,png}');
const galleryImages = galleryImageModules.map(module => module.default.src);
---

<div class="side-projects-container">
  <h2 class="section-title">{sideProjects.titles?.section || (lang === 'pt' ? 'Projetos Paralelos' : 'Side Projects')}</h2>
  
  {sectionDescription && <p class="section-intro">{sectionDescription}</p>}
  
  <!-- Podcast Section -->
  <div class="project-container">
    <h3 class="subsection-title">{sideProjects.titles?.podcast || 'Podcast'}</h3>
    <p class="section-description" set:html={processMarkdown(sideProjects.descriptions?.podcast || '')}></p>
    <div class="podcast-embed">
      <iframe 
        style="border-radius:12px; border: 0;" 
        src={sideProjects.embeds?.podcast?.src || "https://open.spotify.com/embed/show/4lj3PvhecSWd5wUJAF3Lk6?utm_source=generator&theme=0"} 
        width={sideProjects.embeds?.podcast?.width || "100%"} 
        height={sideProjects.embeds?.podcast?.height || "352"} 
        allowfullscreen
        allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
        loading="lazy"
        fetchpriority="low"
        class="media-iframe"
        onload="this.parentNode.classList.add('loaded')"
        onerror="this.parentNode.classList.add('error')"
        title="Mesa do Canto Podcast"
      ></iframe>
      <div class="iframe-loading">Loading...</div>
      <div class="iframe-error">Sorry, content couldn't be loaded. Please try again later.</div>
    </div>
  </div>
  
  <!-- DJ Sets Section -->
  <div class="project-container">
    <h3 class="subsection-title">{sideProjects.titles?.dj || (lang === 'pt' ? 'Sets Recentes' : 'Latest Sets')}</h3>
    <p class="section-description" set:html={processMarkdown(sideProjects.descriptions?.dj || '')}></p>
    <div class="sets-carousel">
      <button class="carousel-arrow prev" aria-label={t('carousel.previous')}>&#60;</button>
      <div class="carousel-container">
        <div class="carousel-track">
          {sideProjects.embeds?.dj?.map((set: { src: string, title?: string }, index: number) => (
            <div class="carousel-item">
              <div class="iframe-container" data-index={index}>
                {index === 0 ? (
                  <iframe 
                    width="100%" 
                    height="120" 
                    src={set.src} 
                    style="border: 0;" 
                    title={set.title || `Set ${index + 1}`}
                    loading="lazy"
                    class="media-iframe"
                    onload="this.parentNode.classList.add('loaded')"
                    onerror="this.parentNode.classList.add('error')"
                  ></iframe>
                ) : (
                  <iframe 
                    width="100%" 
                    height="120" 
                    data-src={set.src} 
                    style="border: 0;" 
                    title={set.title || `Set ${index + 1}`}
                    loading="lazy"
                    class="media-iframe"
                    onload="this.parentNode.classList.add('loaded')"
                    onerror="this.parentNode.classList.add('error')"
                  ></iframe>
                )}
                <div class="iframe-loading">Loading...</div>
                <div class="iframe-error">Sorry, content couldn't be loaded.</div>
              </div>
            </div>
          ))}
        </div>
      </div>
      <button class="carousel-arrow next" aria-label={t('carousel.next')}>&#62;</button>
    </div>
  </div>

  <!-- Playlists Section -->
  <div class="project-container">
    <h3 class="subsection-title">{sideProjects.titles?.playlists || (lang === 'pt' ? 'As Minhas Playlists' : 'My Playlists')}</h3>
    <p class="section-description" set:html={processMarkdown(sideProjects.descriptions?.playlistsIntro || '')}></p>
    <div class="playlists-carousel">
      <button class="carousel-arrow playlist-prev" aria-label={t('carousel.previousPlaylist')}>&#60;</button>
      <div class="playlists-container">
        <div class="playlists-track">
          {sideProjects.embeds?.playlists?.map((playlist: { src: string, title?: string, description?: string }, index: number) => (
            <div class="playlist-item">
              <div class="iframe-container" data-index={index}>
                {index === 0 ? (
                  <iframe 
                    style="border-radius:12px; border: 0;" 
                    src={playlist.src} 
                    width="100%" 
                    height="352" 
                    allowfullscreen
                    allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
                    loading="lazy" 
                    title={playlist.title || `Playlist ${index + 1}`}
                    class="media-iframe"
                    onload="this.parentNode.classList.add('loaded')"
                    onerror="this.parentNode.classList.add('error')"
                  ></iframe>
                ) : (
                  <iframe 
                    style="border-radius:12px; border: 0;" 
                    data-src={playlist.src} 
                    width="100%" 
                    height="352" 
                    allowfullscreen
                    allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
                    loading="lazy" 
                    title={playlist.title || `Playlist ${index + 1}`}
                    class="media-iframe"
                    onload="this.parentNode.classList.add('loaded')"
                    onerror="this.parentNode.classList.add('error')"
                  ></iframe>
                )}
                <div class="iframe-loading">Loading...</div>
                <div class="iframe-error">Sorry, content couldn't be loaded.</div>
              </div>
              {playlist.description && (
                <div class="playlist-info">
                  <p class="playlist-description" set:html={processMarkdown(playlist.description)}></p>
                </div>
              )}
            </div>
          ))}
        </div>
      </div>
      <button class="carousel-arrow playlist-next" aria-label={t('carousel.nextPlaylist')}>&#62;</button>
    </div>
  </div>

  <!-- Photography Section -->
  <div class="project-container">
    <h3 class="subsection-title">{sideProjects.titles?.photography || (lang === 'pt' ? 'Fotografia' : 'Photography')}</h3>
    <p class="section-description" set:html={processMarkdown(sideProjects.descriptions?.photography || '')}></p>
    <div class="photo-gallery">
      {galleryImages.map((image, index) => (
        <div class="photo-item" data-index={index}>
          <img 
            src={image} 
            alt={`Photo ${index + 1}`} 
            loading={index < 3 ? "eager" : "lazy"}
            width="300"
            height="400"
            oncontextmenu="return false;"
          />
        </div>
      ))}
    </div>
  </div>
</div>

<!-- Include the Photo Modal component -->
<PhotoModal />

<style>
  /* User selection disable */
  .side-projects-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 4rem 0;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
  }

  .section-title {
    font-size: var(--font-size-2xl);
    color: var(--color-cosmic-latte);
    margin-bottom: 2rem;
    font-family: var(--font-family-title);
  }

  .section-intro {
    margin-bottom: 2rem;
    color: var(--color-gray-200);
    font-size: var(--font-size-base);
    line-height: var(--line-height-loose);
    font-style: italic;
  }

  .project-container {
    margin-bottom: 4rem;
  }

  .project-container:last-child {
    margin-bottom: 0;
  }

  .subsection-title {
    font-size: var(--font-size-xl);
    color: var(--color-cosmic-latte);
    margin-bottom: 1rem;
    font-family: var(--font-family-title);
  }

  .section-description {
    margin-bottom: 2rem;
    line-height: var(--line-height-loose);
    color: var(--color-gray-300);
    font-size: var(--font-size-base);
    max-width: 90%;
    border-left: 3px solid var(--color-cosmic-latte-20);
    padding-left: 1rem;
    font-style: italic;
  }

  /* Sets Carousel Styles */
  .sets-carousel, .playlists-carousel {
    display: flex;
    align-items: center;
    gap: 1rem;
    width: 100%;
    max-width: 100%;
    margin-bottom: 1rem;
  }

  .carousel-container, .playlists-container {
    flex: 1;
    overflow: hidden;
    width: 100%;
    border-radius: 12px;
    background-color: var(--color-gray-900);
    border: 1px solid var(--color-gray-700);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
  }

  .carousel-track, .playlists-track {
    display: flex;
    transition: transform 0.3s ease;
  }

  .carousel-item, .playlist-item {
    flex: 0 0 100%;
    padding: 0.75rem;
  }

  .carousel-arrow, .playlist-arrow {
    background: rgba(0, 0, 0, 0.5);
    color: white;
    border: 2px solid var(--color-gray-700);
    font-size: 1.5rem;
    padding: 0.5rem 1rem;
    cursor: pointer;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    width: 40px;
    height: 40px;
  }

  .carousel-arrow:hover, .playlist-arrow:hover {
    background: var(--color-cosmic-latte-10);
    border-color: var(--color-cosmic-latte);
    transform: translateY(-2px);
  }

  .carousel-arrow:disabled, .playlist-arrow:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Photo Gallery Styles */
  .photo-gallery {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 1.25rem;
    margin-bottom: 2rem;
  }

  .photo-item {
    position: relative;
    aspect-ratio: 3/4;
    overflow: hidden;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    border: 1px solid var(--color-gray-700);
  }

  .photo-item:hover {
    transform: translateY(-5px) scale(1.02);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
    border-color: var(--color-cosmic-latte);
  }

  .photo-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    transition: transform 0.5s ease;
  }
  
  .photo-item:hover img {
    transform: scale(1.05);
  }

  /* Responsive Styles */
  @media (max-width: 768px) {
    .section-container {
      padding: 0;
    }

    .side-projects-container {
      padding: 2rem 1rem;
    }

    .section-title {
      font-size: var(--font-size-xl);
      margin-bottom: 1.5rem;
    }

    .section-intro, .section-description {
      max-width: 100%;
      font-size: var(--font-size-sm);
    }

    .project-container {
      margin-bottom: 3rem;
    }

    .playlists-carousel {
      flex-direction: row;
    }

    .playlist-item, .carousel-item {
      flex: 0 0 100%;
      width: 100%;
    }

    .sets-carousel,
    .playlists-carousel {
      padding: 0;
    }

    .carousel-container,
    .playlists-container {
      width: 100%;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x mandatory;
      padding-bottom: 0.5rem;
      border-radius: 8px;
    }

    .carousel-track,
    .playlists-track {
      display: flex;
      scroll-snap-type: x mandatory;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }

    .carousel-item,
    .playlist-item {
      scroll-snap-align: start;
      flex: 0 0 100%;
      width: 100%;
      padding: 0.5rem;
    }

    .photo-gallery {
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
      padding: 0;
      margin: 0 auto;
    }
  }

  @media (max-width: 480px) {
    .section-title {
      font-size: var(--font-size-lg);
    }

    .subsection-title {
      font-size: var(--font-size-base);
    }

    .sets-carousel,
    .playlists-carousel {
      flex-direction: column;
      gap: 0.5rem;
    }

    .carousel-arrow,
    .carousel-arrow.playlist-prev,
    .carousel-arrow.playlist-next {
      display: none;
    }

    .photo-gallery {
      grid-template-columns: 1fr;
    }
  }

  .podcast-embed, .iframe-container {
    position: relative;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 12px;
    min-height: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    border: 1px solid var(--color-gray-700);
  }

  .podcast-embed .media-iframe, .iframe-container .media-iframe {
    opacity: 0;
    transition: opacity 0.5s ease;
    width: 100%;
    height: 100%;
  }

  .podcast-embed.loaded .media-iframe, .iframe-container.loaded .media-iframe {
    opacity: 1;
  }

  .iframe-loading, .iframe-error {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    padding: 1rem;
    background: rgba(0, 0, 0, 0.7);
    border-radius: 8px;
    z-index: 1;
  }

  .iframe-error {
    display: none;
    color: #ff6b6b;
  }

  .podcast-embed.loaded .iframe-loading, .iframe-container.loaded .iframe-loading {
    display: none;
  }

  .podcast-embed.error .iframe-loading, .iframe-container.error .iframe-loading {
    display: none;
  }

  .podcast-embed.error .iframe-error, .iframe-container.error .iframe-error {
    display: block;
  }

  .playlist-info {
    margin-top: 1rem;
    padding: 0.5rem;
    background: var(--color-gray-900);
    border-radius: 6px;
    border: 1px solid var(--color-gray-700);
  }

  .playlist-description {
    font-size: var(--font-size-sm);
    color: var(--color-gray-300);
    margin: 0;
    line-height: 1.5;
    text-align: center;
  }
</style>

<script>
  /**
   * Loads the iframe content for a given index
   * @param {number} index - The index of the item to load
   * @param {string} carouselType - Either 'sets' or 'playlists'
   */
  function loadIframeContent(index: number, carouselType: string) {
    // Find the container based on carousel type
    const containerSelector = carouselType === 'sets' ? '.carousel-track' : '.playlists-track';
    const container = document.querySelector(containerSelector);
    
    if (!container) return;
    
    // Find the iframe container with the matching index
    const iframeContainer = container.querySelector(`.iframe-container[data-index="${index}"]`);
    
    if (!iframeContainer) return;
    
    // Find the iframe within this container
    const iframe = iframeContainer.querySelector('iframe');
    
    if (!iframe || !iframe.dataset.src) return;
    
    // Set the src from data-src to load the content
    iframe.src = iframe.dataset.src;
    
    // Remove the data-src attribute so we don't load it again
    iframe.removeAttribute('data-src');
  }

  // When using PhotoModal component, set up click handlers to use window.openPhotoModal
  document.addEventListener('DOMContentLoaded', () => {
    // Set up photo item clicks to open the modal
    const photoItems = document.querySelectorAll('.photo-item');
    photoItems.forEach((item, index) => {
      item.addEventListener('click', () => {
        if (typeof window.openPhotoModal === 'function') {
          window.openPhotoModal(index);
        }
      });
    });
  });

  // Add touch swipe functionality for mobile
  document.addEventListener('DOMContentLoaded', () => {
    const carouselTracks = document.querySelectorAll('.carousel-track, .playlists-track');
    
    carouselTracks.forEach(track => {
      let startX: number, startScrollLeft: number, isDragging = false;
      // Remove unused variable
      // let startY: number;

      const startDrag = (e: MouseEvent | TouchEvent) => {
        isDragging = true;
        startX = 'touches' in e ? e.touches[0].pageX : e.pageX;
        // startY = 'touches' in e ? e.touches[0].pageY : e.pageY; // Not used
        startScrollLeft = (track.parentElement as HTMLElement).scrollLeft;
      }

      const drag = (e: MouseEvent | TouchEvent) => {
        if (!isDragging) return;
        e.preventDefault();
        const x = 'touches' in e ? e.touches[0].pageX : e.pageX;
        // Remove unused variable
        // const y = 'touches' in e ? e.touches[0].pageY : e.pageY;
        
        // Calculate horizontal scroll based on drag distance
        const deltaX = x - startX;
        (track.parentElement as HTMLElement).scrollLeft = startScrollLeft - deltaX;
      }

      const endDrag = () => {
        isDragging = false;
      }

      // Mouse events
      track.addEventListener('mousedown', startDrag);
      track.addEventListener('mousemove', drag);
      track.addEventListener('mouseup', endDrag);
      track.addEventListener('mouseleave', endDrag);
      
      // Touch events
      track.addEventListener('touchstart', startDrag as EventListener);
      track.addEventListener('touchmove', drag as EventListener);
      track.addEventListener('touchend', endDrag);
    });
  });

  // Carousel functionality
  const carouselTrack = document.querySelector('.carousel-track') as HTMLElement;
  const carouselItems = document.querySelectorAll('.carousel-item');
  const carouselPrevBtn = document.querySelector('.carousel-arrow.prev') as HTMLButtonElement;
  const carouselNextBtn = document.querySelector('.carousel-arrow.next') as HTMLButtonElement;
  
  let currentIndex = 0;

  function updateCarousel() {
    if (carouselTrack) {
      const percentage = currentIndex * -100;
      carouselTrack.style.transform = `translateX(${percentage}%)`;
      
      // Update button states
      if (carouselPrevBtn) carouselPrevBtn.disabled = currentIndex === 0;
      if (carouselNextBtn) carouselNextBtn.disabled = currentIndex === carouselItems.length - 1;
      
      // Load the current iframe content
      loadIframeContent(currentIndex, 'sets');
      
      // Preload the next iframe content (for smoother transitions)
      if (currentIndex < carouselItems.length - 1) {
        loadIframeContent(currentIndex + 1, 'sets');
      }
    }
  }

  carouselPrevBtn?.addEventListener('click', () => {
    if (currentIndex > 0) {
      currentIndex--;
      updateCarousel();
    }
  });

  carouselNextBtn?.addEventListener('click', () => {
    if (currentIndex < carouselItems.length - 1) {
      currentIndex++;
      updateCarousel();
    }
  });

  // Initialize carousel
  updateCarousel();

  // Playlists Carousel functionality
  const playlistsTrack = document.querySelector('.playlists-track') as HTMLElement;
  const playlistItems = document.querySelectorAll('.playlist-item');
  const playlistPrevBtn = document.querySelector('.carousel-arrow.playlist-prev') as HTMLButtonElement;
  const playlistNextBtn = document.querySelector('.carousel-arrow.playlist-next') as HTMLButtonElement;
  
  let currentPlaylistIndex = 0;

  function updatePlaylistCarousel() {
    if (playlistsTrack) {
      const percentage = currentPlaylistIndex * -100;
      playlistsTrack.style.transform = `translateX(${percentage}%)`;
      
      // Update button states
      if (playlistPrevBtn) playlistPrevBtn.disabled = currentPlaylistIndex === 0;
      if (playlistNextBtn) playlistNextBtn.disabled = currentPlaylistIndex === playlistItems.length - 1;
      
      // Load the current iframe content
      loadIframeContent(currentPlaylistIndex, 'playlists');
      
      // Preload the next iframe content (for smoother transitions)
      if (currentPlaylistIndex < playlistItems.length - 1) {
        loadIframeContent(currentPlaylistIndex + 1, 'playlists');
      }
    }
  }

  playlistPrevBtn?.addEventListener('click', () => {
    if (currentPlaylistIndex > 0) {
      currentPlaylistIndex--;
      updatePlaylistCarousel();
    }
  });

  playlistNextBtn?.addEventListener('click', () => {
    if (currentPlaylistIndex < playlistItems.length - 1) {
      currentPlaylistIndex++;
      updatePlaylistCarousel();
    }
  });

  // Initialize playlist carousel
  updatePlaylistCarousel();
</script> 